version: '3.3'

networks:
  gitea:
    external: false

volumes:
  traefik_acme:
  traefik_logs:    
    
services:
  traefik:
    image: traefik:v2.2
    environment:
      DO_AUTH_TOKEN: "{{ DO_AUTH_TOKEN }}"
    ports:
      - 80:80/tcp
      - 443:443/tcp
      - 8080:8080/tcp
    volumes:
      - traefik_acme:/acme
      - traefik_logs:/log
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/josiah/apps/test/traefik.toml:/etc/traefik/traefik.toml
    deploy:
      mode: global      
      placement:
        constraints:
          - node.role == manager
    labels:
      - "traefik.enable=true"

      # Dashboard      
      - "traefik.http.routers.awfulAll-traefik-api.rule=Host(`awful-1.awful.club`)&&(PathPrefix(`/dashboard`)"
      - "traefik.http.routers.awfulAll-traefik-api.service=api@internal"
      - "traefik.http.routers.awfulAll-traefik-api.entryPoint=https"
      - "traefik.http.routers.awfulAll-traefik-api.tls.certresolver=awfulAll-resolver"
      - "traefik.http.routers.awfulAll-traefik-api.tls=true"

  awfulAll-whoami:
    image: containous/whoami:latest
    
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.awfulAll-whoami.rule=Host(`whoami.awful.club`)"
      - "traefik.http.routers.awfulAll-whoami.service=awfulAll-whoami"
      - "traefik.http.routers.awfulAll-whoami.entryPoint=https"
      - "traefik.http.routers.awfulAll-whoami.tls.certresolver=awfulAll-resolver"
      - "traefik.http.routers.awfulAll-whoami.tls=true"            

  # root-handlers:
  #   image: nginx:1.18
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.awfulAll-whoami.rule=Host(`whoami.awful.club`)"
  #     - "traefik.http.routers.awfulAll-whoami.service=awfulAll-whoami"
  #     - "traefik.http.routers.awfulAll-whoami.entryPoints=https"
  #     - "traefik.http.routers.awfulAll-whoami.tls.certresolver=awfulAll-resolver"
  #     # - "traefik.http.services.awfulAll-whoami.loadbalancer.server.port=443"      
  #   volumes:
  #     - /home/josiah/apps/nginx:/etc/nginx/conf.d
